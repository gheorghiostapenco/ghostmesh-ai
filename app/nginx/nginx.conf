events {
    worker_connections 1024;
}

http {
    # --- BASIC SETTINGS ---
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # --- SECURITY HARDENING HEADERS (Layer 4) ---
    # 1. HSTS: Force browsers to use HTTPS for 1 year (prevents downgrade attacks)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 2. Anti-Clickjacking: Prevent your site from being framed by others
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 3. Anti-Sniffing: Prevent browser from guessing file types
    add_header X-Content-Type-Options "nosniff" always;
    
    # 4. XSS Filter: Enable browser's built-in Cross-Site Scripting filter
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 5. Referrer Policy: Protect user privacy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # --- SSL SETTINGS (Shared across all blocks) ---
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- PROXY DEFAULTS (Applied to all services) ---
    # Pass the Real User IP from Cloudflare to the App
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $http_cf_connecting_ip;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket Support (Critical for Portainer/Jenkins)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # ==========================================
    # 1. THE LOBBY (hub.crystalpine.dev)
    # ==========================================
    server {
        listen 443 ssl;
        http2 on;
        server_name hub.crystalpine.dev;
        
        location / { 
            proxy_pass http://homepage:3000; 
        }
    }

    # ==========================================
    # 2. THE FACTORY (build.crystalpine.dev)
    # ==========================================
    server {
        listen 443 ssl;
        http2 on;
        server_name build.crystalpine.dev;
        
        location / { 
            proxy_pass http://jenkins:8080;
            # Increase upload size for build artifacts
            client_max_body_size 50m; 
        }
    }

    # ==========================================
    # 3. THE CONTROL ROOM (monitor.crystalpine.dev)
    # ==========================================
    server {
        listen 443 ssl;
        http2 on;
        server_name monitor.crystalpine.dev;
        
        location / { 
            proxy_pass http://grafana:3000; 
        }
    }

    # ==========================================
    # 4. THE MANAGER (admin.crystalpine.dev)
    # ==========================================
    server {
        listen 443 ssl;
        http2 on;
        server_name admin.crystalpine.dev;
        
        location / { 
            proxy_pass http://portainer:9000; 
        }
    }

    # ==========================================
    # 5. THE AI API (crystalpine.dev)
    # ==========================================
    server {
        listen 443 ssl;
        http2 on;
        server_name crystalpine.dev;
        
        location / { 
            proxy_pass http://fastapi_app:8000; 
        }
    }

    # ==========================================
    # CATCH-ALL REDIRECT (HTTP -> HTTPS)
    # ==========================================
    server {
        listen 80;
        server_name *.crystalpine.dev crystalpine.dev;
        return 301 https://$host$request_uri;
    }
}
